<!-- Overview View
  The main dashboard display which leads to all other views.
  Content: 4 sections including:
    recent builds
    summaries
    team stats
    metrics by package type
-->
<!-- top fluid row -->
<!-- Recent Builds section -->
<div id='topRowContainer' class='row-fluid'>
  <div id='recentBuildsContent' class='span4 contentContainer'>
    <div id ='recentBuildsContentTitle' class='row-fluid'>
      <h3 class='contentTitle span4'>Recent Builds</h3>
      <span class='span2 offset6'>
        <div class="btn-group">
          <button class="moreBtn btn btn-mini dropdown-toggle" data-toggle="dropdown" type="button"><i class="icon-wrench"></i></button>
          <ul class='dropdown-menu pull-right'>
            <li><a tabindex="-1" href="#">Adjust Timescale</a></li>
          </ul>
        </div>
        <div class="btn-group">
          <button class="moreBtn btn btn-mini dropdown-toggle" data-toggle="dropdown" type="button"><i class="icon-search"></i></button>
          <ul class='dropdown-menu pull-right'>
            <li><a tabindex="-1" href="#">Historical Build Log</a></li>
          </ul>
        </div>
      </span>
    </div>
    <table id='recentBuildsTable' class='table table-striped table-hover'>
      <thead>
        <th class='result'>Result</th>
        <th class='package'>Package</th>
        <th class='dist'>Dist</th>
        <th class='buildTime'><i class="icon-time"></i></th>
        <th id = 'trendHeader'class='trend'><i class="icon-time"></i> Trend by Dist (All Time)</th>
      </thead>
      <tbody>
      <% @stats[:latest].each do |row| %>
        <% rowID        = "sparkline#{row.id}row" %>
        <% modalMessage = "#{row.package_name} (#{row.dist}): built in #{row.jenkins_build_time.round(2)} seconds."%>
        <%
           log = row.build_log.gsub! /'|"/, ''
           recentBuildsDataHash = Hash[ :date                => row.date,
                                        :package_name        => row.package_name,
                                        :dist                => row.dist,
                                        :package_type        => row.package_type,
                                        :jenkins_build_time  => row.jenkins_build_time,
                                        :package_build_time  => row.package_build_time,
                                        :build_user          => row.build_user,
                                        :build_loc           => row.build_loc,
                                        :version             => row.version,
                                        :pe_version          => row.pe_version,
                                        :success             => row.success,
                                        :build_log           => row.build_log
                                      ]
        %>

        <tr id='<%= rowID %>' onmouseover='createTableRowModal(<%= "#{rowID}" %>, <%= "\"#{modalMessage}\"" %>)' onmouseout='removeTableModal()' onclick='createRecentBuildsModal(<%= recentBuildsDataHash.to_json  %>, <%= "#{rowID}" %>)'>
          <% if row.success == true
               circleColor = 'limegreen'
             else
               circleColor = 'red'
             end
          %>
          <td>
            <svg id='resultCell'  xmlns="http://www.w3.org/2000/svg" version="1.1">
              <defs>
                <filter id="drop-shadow">
                  <feGaussianBlur in="SourceGraphic" stdDeviation="1" />
                </filter>
              </defs>
              <circle class='resultCircle' r='5' cx='20' cy='8' filter="url(#drop-shadow)"
                fill=<%= "#{circleColor}" %>>
            </svg>
          </td>
          <td><%= row.package_name %></td>
          <td><%= row.dist %></td>
          <td><%= "#{row.jenkins_build_time.round(0)} sec" %></td>
          <td id="<%= "sparkline#{row.id}" %>">
            <%= time_array = Array.new
                @trends["#{row.package_name}-#{row.dist}"].each do |row|
                  time_array << row.jenkins_build_time
                end
                puts time_array.inspect
            %>
            <script type='text/javascript'>
              createRecentSparkline( <%= time_array %>, <%= "sparkline#{row.id}" %> )
            </script>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </div>

<!-- Summaries section -->
  <div id='summaryContent' class='span7 contentContainer'>
    <div id='summaryContentTitle' class='row-fluid'>
      <h3 class='contentTitle span4'>Metric Summaries</h3>
      <span class='span2 offset6'>
        <div class="btn-group">
          <button class="moreBtn btn btn-mini dropdown-toggle" data-toggle="dropdown" type="button"><i class="icon-wrench"></i></button>
          <ul class='dropdown-menu pull-right'>
            <li><a tabindex="-1" href="#">Adjust Timescale</a></li>
          </ul>
        </div>
        <div class="btn-group">
          <button class="moreBtn btn btn-mini dropdown-toggle" data-toggle="dropdown" type="button"><i class="icon-search"></i></button>
          <ul class='dropdown-menu pull-right'>
            <li class="dropdown-submenu pull-left">
              <a tabindex="-1" href="#">Detailed View</a>
              <ul class="dropdown-menu">
                <li><a tabindex="-1" href="/summary/builds">Builds</a></li>
                <li><a tabindex="-1" href="/summary/builds">Shipped</a></li>
                <li><a tabindex="-1" href="/summary/users">Users</a></li>
              </ul>
            </li>
            <li class="divider"></li>
            <li>
              <a tabindex="-1" href="#">More Views</a>
            </li>
          </ul>
        </div>
      </span>
    </div>
    <div class='row-fluid'>
      <div id='summaryBuildNumber' class='span5'>
        <h4 class='contentTitle'>Builds over Last 12 Weeks</h4>
        <div id='summaryBuildNumberContent'>
          <div class='yAxisLabel'>Builds</div>
          <script type='text/javascript'>
            createLineGraph(<%= @totalBuildsTimeSeries %>, <%= @failedBuildsTimeSeries %>, 460, 445, 70, '#summaryBuildNumberContent', '#summaryBuildsGraph', 'builds')
          </script>
          <div id='summaryBuildsLegend'>
            <svg id='summaryBuildsLegendTotal' xmlns="http://www.w3.org/2000/svg" version="1.1">
              <circle id='totalBuildsLegendCircle' class='legendCircle' cx='20' cy='4' r='4'></circle>
              <text x='30' y='12' fill='black'>Total</text>
            </svg>
            <svg id='summaryBuildsLegendFailed'  xmlns="http://www.w3.org/2000/svg" version="1.1">
              <circle id='failedBuildsLegendCircle' class='legendCircle' cx='20' cy='8' r='4'></circle>
              <text x='30' y='12' fill='black'>Failed</text>
            </svg>
          </div>
          <div id='summaryBuildsXLabel'>Weeks Ago</div>
        </div>
      </div>

      <div id='summaryShipped' class='span3'>
        <h4 class='contentTitle'>Shipped Packages this Month</h4>
        <div id='summaryShippedContent'>
          <div class='yAxisLabel'>Shipped</div>
            <script type='text/javascript'>
              createHistogram(<%= [@stats[:shipped][:final].to_json, @stats[:shipped][:rc].to_json]%>, 200, 440, 70, 0, '#summaryShippedContent', 'shipped', '/summary/shipped/' )
            </script>
          </div>
        </div>

      <div id='summaryTables' class='span3'>
        <div id='summaryFreqPackages'>
          <h4 class='summaryHalfTableTitle contentTitle'>Frequently Built Packages</h5>
          <div id='summaryFreqPackagesContent' class='summaryHalfChart'>
            <table class='table table-striped table-hover freqTable'>
              <thead>
                <th class='freqPkgTableHead'>Package</th>
                <th class='freqPkgTableHead'>Builds</th>
              </thead>
              <tbody>
                <% @freqPackages.each do |pkg| %>
                  <% rowID        = "#{pkg[0][0...1]}#{pkg[1]}" %>
                  <% modalMessage = "#{pkg[0]}: built #{pkg[1]} times."%>
                  <tr id='<%= rowID %>' onmouseover='createTableRowModal(<%= "#{rowID}" %>, <%= "\"#{modalMessage}\"" %>)' onmouseout='removeTableModal()'>
                    <td><strong><%= pkg[0] %></strong></td>
                    <td><%= pkg[1] %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
        <div id='summaryFreqUsers'>
          <h4 class='summaryHalfTableTitle contentTitle'>Most Active Users</h5>
          <div id='summaryFreqUsersContent' class='summaryHalfChart'>
            <table class='table table-striped table-hover freqTable'>
              <thead>
                <th class='freqUsersTableHead'>Username</th>
                <th class='freqUsersTableHead'>Builds</th>
              </thead>
              <tbody>
                <% @freqUsers.each do |user| %>
                  <% rowID        = "#{user[0]}#{user[1]}" %>
                  <% modalMessage = "#{user[0]} has built #{user[1]} packages."%>
                  <tr id='<%= rowID %>' onmouseover='createTableRowModal(<%= "#{rowID}" %>, <%= "\"#{modalMessage}\"" %>)' onmouseout='removeTableModal()'>

                    <td><strong><%= user[0] %></strong></td>
                    <td><%= user[1] %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- Tooltips for graphs and charts, to be styled by D3 -->
<div id='graphToolTip' class='hidden graphToolTip'>
  <p><strong><span id='graphToolTipTitle'</span></strong></p>
  <span id='graphToolTipFooter' class='toolTipDesc'></span>
</div>

<div id='tableModal' class='hidden tableModal'>
  <p id='tableModalTitle'></p>
  <span id='tableModalFooter' class='toolTipDesc'></span>
</div>

<div id='recentBuildsModal' class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 id='recentBuildsModalTitle' class="modal-title"></h4>
      </div>
      <div class="modal-body">
        <div class='row-fluid'>
          <span class='span5'>
            <table class='table'>
              <tbody>
                <tr>
                  <td class='recentBuildsModalLabel'>Package:</td>
                  <td id='recentBuildsModalPackageCell'></td>
                </tr>
                <tr>
                  <td class='recentBuildsModalLabel'>Package Type:</td>
                  <td id='recentBuildsModalTypeCell'></td>
                </tr>
                <tr>
                  <td class='recentBuildsModalLabel'>Distribution:</td>
                  <td id='recentBuildsModalDistCell'></td>
                </tr>
                <tr>
                  <td class='recentBuildsModalLabel'>Builder:</td>
                  <td id='recentBuildsModalBuilderCell'></td>
                </tr>
                <tr>
                  <td class='recentBuildsModalLabel'>Build Host:</td>
                  <td id='recentBuildsModalHostCell'></td>
                </tr>
              </tbody>
            </table>
          </span>
          <span class='span5 offset1'>
            <table class='table'>
              <tbody>
                <tr>
                  <td class='recentBuildsModalLabel'>Version:</td>
                  <td id='recentBuildsModalVersionCell'></td>
                </tr>
                <tr>
                  <td class='recentBuildsModalLabel'>PE Version:</td>
                  <td id='recentBuildsModalPeVersionCell'></td>
                </tr>
              </tbody>
            </table>
          </span>
        </div>

        <div class='row-fluid'>
          <table id='recentBuildsModalTimeTable' class='table'>
            <tbody>
              <tr><td>This package was built remotely via Jenkins</td></tr>
              <tr>
                <td class='recentBuildsModalLabel'>Package Build Time:</td>
                <td id='recentBuildsModalPackageTimeCell'></td>
              </tr>
              <tr>
                <td class='recentBuildsModalLabel'>Jenkins Job Time:</td>
                <td id='recentBuildsModalJenkinsTimeCell'></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div id='recentBuildsModalStatus'>
          <i id='recentBuildsModalStatusIcon'></i><span id='recentBuildsModalStatusText'></span>
          <button id='recentBuildsModalLogButton' class="btn btn-info" type="button" onclick='createBuildLogModal()'>View Build Log</button>
        </div>
        <br><br>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

  <!-- Build log modal -->
<div id='logModal' class="modal hide fade" data-backdrop='false'>
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3 id='logTitle'>Modal header</h3>
  </div>
  <div id='logBody' class="modal-body">
    <p id='logContent'></p>
  </div>
  <div class="modal-footer">
    <a href="#" data-dismiss="modal" aria-hidden="true" class="btn">Close</a>
  </div>
</div>

  <!-- Bottom fluid row -->

  <div id='bottomRowContainer' class='row-fluid'>
    <!-- Team Stats section-->
    <div id='teamContent' class='span4 contentContainer'>
      <div id='teamContentTitle' class='row-fluid'>
        <h3 class='contentTitle span4'>Team Statistics</h3>
        <span class='span2 offset6'>
          <div class="btn-group">
            <button class="moreBtn btn btn-mini dropdown-toggle" data-toggle="dropdown" type="button"><i class="icon-wrench"></i></button>
            <ul class='dropdown-menu pull-right'>
              <li><a tabindex="-1" href="#">Adjust Timescale</a></li>
            </ul>
          </div>
          <div class="btn-group">
            <button class="moreBtn btn btn-mini dropdown-toggle" data-toggle="dropdown" type="button"><i class="icon-search"></i></button>
            <ul class='dropdown-menu pull-right'>
              <li><a tabindex="-1" href="#">Detailed View</a></li>
            </ul>
          </div>
        </span>
      </div>
      <div class='row-fluid'>
        <div id='teamBuildComparison' class='span5'>
          <h4 class='contentTitle'>Number of Builds by Team</h4>
          <div id='teamBuildComparisonContent'>
            <div class='yAxisLabel'>Builds</div>
              <script type='text/javascript'>
                createHistogram(<%= [@teamNumBuilds[:release].to_json, @teamNumBuilds[:other].to_json] %>, 200, 450, 70, 20, '#teamBuildComparisonContent', 'builds', '/summary/shipped')
              </script>
          </div>
        </div>
        <div id='otherTeamSeries' class='span7'>
          <h4 class='contentTitle'>Builds by Teams other than Release over Last 12 Weeks</h4>
          <div id='otherTeamSeriesContent'>
            <div class='yAxisLabel'>Builds</div>
             <script type='text/javascript'>
                createLineGraph(<%= @otherTeamBuildSeries %>, <%= [] %>, 460, 450, 40, '#otherTeamSeriesContent', '#otherTeamGraph', 'builds')
              </script>
            <div id='teamsBuildsXLabel'>Weeks Ago</div>
          </div>
      </div>
    </div>
  </div>
    <!-- Metrics by Package Type Section -->
    <div id='typeContent' class='span7 contentContainer'>
      <div id ='typeContentTitle' class='row-fluid'>
        <h3 class='contentTitle span4'>Metrics by Package Type </h3>
        <span class='span2 offset6'>
          <div class="btn-group">
            <button class="moreBtn btn btn-mini dropdown-toggle" data-toggle="dropdown" type="button"><i class="icon-wrench"></i></button>
            <ul class='dropdown-menu pull-right'>
              <li><a tabindex="-1" href="#">Adjust Timescale</a></li>
            </ul>
          </div>
          <div class="btn-group">
            <button class="moreBtn btn btn-mini dropdown-toggle" data-toggle="dropdown" type="button"><i class="icon-search"></i></button>
            <ul class='dropdown-menu pull-right'>
              <li class="dropdown-submenu pull-left">
                <a tabindex="-1" href="#">Detailed View</a>
                <ul class="dropdown-menu">
                  <li><a tabindex="-1" href="/summary/type/deb">Deb</a></li>
                  <li><a tabindex="-1" href="/summary/type/rpm">RPM</a></li>
                  <li><a tabindex="-1" href="/summary/type/gem">Gem</a></li>
                  <li><a tabindex="-1" href="/summary/type/dmg">Dmg</a></li>
                  <li><a tabindex="-1" href="/summary/hosts">Build Hosts</a></li>
                </ul>
              </li>
              <li class="divider"></li>
              <li>
                <a tabindex="-1" href="#">More Views</a>
              </li>
            </ul>
          </div>
        </span>
      </div>
      <div class='row-fluid'>
        <div id='typeBuildNumber' class='span4'>
          <h4 class='contentTitle'>Number of Builds</h4>
          <div id='typeBuildNumberContent' class='typeChartContent'>
            <div class='yAxisLabel'>Builds</div>
            <script type='text/javascript'>
              createHistogram(<%=[@stats[:deb].to_json, @stats[:rpm].to_json, @stats[:gem].to_json, @stats[:dmg].to_json] %>, 350, 440, 70, 100, '#typeBuildNumberContent', 'builds', 'summary/type')
            </script>
          </div>
        </div>

        <div id='typeBuildSpeed' class='span4'>
          <h4 class='contentTitle'>Average Build Speed</h4>
          <div id='typeBuildSpeedContent' class='typeChartContent'>
            <div class='yAxisLabel'>Seconds</div>
            <script type='text/javascript'>
              createHistogram(<%= [@stats[:deb].to_json, @stats[:rpm].to_json, @stats[:gem].to_json, @stats[:dmg].to_json] %>, 350, 440, 70, 20, '#typeBuildSpeedContent', 'seconds', '/summary/type')
            </script>
          </div>
        </div>

        <div id='typeBuildHost' class='span3'>
          <h4 class='contentTitle'>Most Used Build Hosts by Type</h4>
          <div id='typeBuildHostContent' class='typeChartContent'>
            <table id='freqHostTable' class='table table-striped table-hover'>
              <thead>
                <th class='freqHostTableHead'>Type</th>
                <th class='freqHostTableHead'>Host</th>
                <th class='freqHostTableHead'>Builds</th>
                <th id='freqHostPercentRow' class='freqHostTableHead'>Percentage of Builds</th>
              </thead>
              <tbody>
                <% [@stats[:deb], @stats[:rpm], @stats[:gem], @stats[:dmg]].each do |pkgtype| %>
                  <% rowID        = "#{pkgtype[:key]}row"%>
                  <% modalMessage = "#{pkgtype[:freqHost][0]}: #{pkgtype[:freqHostPercent]}% of all #{pkgtype[:key]} builds." %>
                  <tr id='<%= rowID %>' onmouseover='createTableRowModal(<%= "#{rowID}" %>, <%= "\"#{modalMessage}\"" %>)' onmouseout='removeTableModal()' onclick='document.location.href=<%= "\"/summary/hosts/#{pkgtype[:freqHost][0]}\"" %>'>
                    <td><strong><%= pkgtype[:key] %></strong></td>
                    <td><%= pkgtype[:freqHost][0] %></td>
                    <td><%= pkgtype[:freqHost][1] %></td>
                    <td id='freqHostPercentRow'><%= "#{pkgtype[:freqHostPercent]}%" %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- If the screen resolution is small, stretch each box to fill the width of the screen -->
<script type='text/javascript'>
  var recentBuilds = document.getElementById("recentBuildsContent");
  var teamBuilds   = document.getElementById("teamContent");
  if(screen.width < 1600) {
    recentBuilds.style.minWidth = "1300px";
    teamBuilds.style.minWidth   = "1300px";
  } else {
    recentBuilds.style.minWidth = "900px";
    teamBuilds.style.minWidth   = "900px";
  }
</script>
